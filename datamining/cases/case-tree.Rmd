---
title: "基本分类模型案例：股票市场走势预测"
author: "吴翔"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
options(digits = 3)

```
## 概述

我们通过R语言`ISLR`包中股票市场走势的案例来阐述如何使用如下基本分类模型：

- logistic回归
- LDA
- QDA
- KNN

数据集`Smarket`包含了2001-2005年1250天里S&P 500股票指数的投资回报率。Lag1 ~ Lag5是过去5个交易日的投资回报率，Volume为前一交易日的股票成交量（单位为十亿），Today为当日的投资回报率，Direction为市场走势方向（Up或者Down）。

```{r}

# clean the work directory
rm(list = ls())

# set seeds
set.seed(123)

# read dataset
suppressMessages(library(ISLR))
suppressMessages(library(tidyverse))
data("Smarket")
# display the variables
str(Smarket)
# summary of dataset
summary(Smarket)

```

## 决策树模型

我们用2001-2004年的数据作为训练集，2005年的数据作为测试集。

```{r}

# training set
train <- Smarket$Year < 2005
smarket.test <- Smarket[!train, ]
smarket.train <- Smarket[train, ]

```

训练集包含`r nrow(smarket.train)`个样本，测试集包含`r nrow(smarket.test)`个样本。

```{r}

suppressMessages(library(tree))
# decision tree
tree.fit <- tree(Direction ~ Lag1 + Lag2 + Lag3 + Lag4 + Lag5 + Volume, data = smarket.train)
summary(tree.fit)
plot(tree.fit)
# predictions
glm.pred <- ifelse(predict(glm.fit, smarket.test, type = "response") > 0.5, "Up", "Down")
# compare predictions with true values
table(glm.pred, smarket.test$Direction)
# performance
mean(glm.pred == smarket.test$Direction)

```

可以看到，logistic回归预测的准确率为`r mean(glm.pred == smarket.test$Direction)`，小于随机猜测。

检视模型，发现纳入了过多无关变量，因而出现了过度拟合的问题。因此，仅纳入Lag1和Lag2，重新运行logistic回归模型。


```{r}

# logistic regression
glm.fit <- glm(Direction ~ Lag1 + Lag2, data = smarket.train, family = binomial)
summary(glm.fit)
# predictions
glm.pred <- ifelse(predict(glm.fit, smarket.test, type = "response") > 0.5, "Up", "Down")
# compare predictions with true values
table(glm.pred, smarket.test$Direction)
# performance
mean(glm.pred == smarket.test$Direction)

```

此时logistic回归预测的准确率为`r mean(glm.pred == smarket.test$Direction)`，略大于随机猜测。
